/********************************************************************* 
 * File Proxy Cache Utility Library by Jason Mayes 2025.
 * Version 1.0.1
 *
 * This was primarily made for caching large (GBs) Web AI Model files.
 * However it can likely be used for other binary files too.
 * For docs see https://github.com/jasonmayes/web-ai-model-proxy-cache
 *--------------------------------------------------------------------
 * Connect with me on social if any questions or comments:
 *
 * LinkedIn: https://www.linkedin.com/in/webai/
 * Twitter / X: https://x.com/jason_mayes
 * Github: https://github.com/jasonmayes
 * CodePen: https://codepen.io/jasonmayes
 *********************************************************************/
let FileProxyCache=function(){const MD5=function(e){var t=function M(e){for(var t,n="0123456789ABCDEF",a="",r=0;r<e.length;r++)t=e.charCodeAt(r),a+=n.charAt(t>>>4&15)+n.charAt(15&t);return a}(function V(e){for(var t="",n=0;n<32*e.length;n+=8)t+=String.fromCharCode(e[n>>5]>>>n%32&255);return t}(function Y(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,a=-271733879,r=-1732584194,i=271733878,c=0;c<e.length;c+=16){var d=n,h=a,o=r,f=i;a=md5_ii(a=md5_ii(a=md5_ii(a=md5_ii(a=md5_hh(a=md5_hh(a=md5_hh(a=md5_hh(a=md5_gg(a=md5_gg(a=md5_gg(a=md5_gg(a=md5_ff(a=md5_ff(a=md5_ff(a=md5_ff(a,r=md5_ff(r,i=md5_ff(i,n=md5_ff(n,a,r,i,e[c+0],7,-680876936),a,r,e[c+1],12,-389564586),n,a,e[c+2],17,606105819),i,n,e[c+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,n=md5_ff(n,a,r,i,e[c+4],7,-176418897),a,r,e[c+5],12,1200080426),n,a,e[c+6],17,-1473231341),i,n,e[c+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,n=md5_ff(n,a,r,i,e[c+8],7,1770035416),a,r,e[c+9],12,-1958414417),n,a,e[c+10],17,-42063),i,n,e[c+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,n=md5_ff(n,a,r,i,e[c+12],7,1804603682),a,r,e[c+13],12,-40341101),n,a,e[c+14],17,-1502002290),i,n,e[c+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,n=md5_gg(n,a,r,i,e[c+1],5,-165796510),a,r,e[c+6],9,-1069501632),n,a,e[c+11],14,643717713),i,n,e[c+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,n=md5_gg(n,a,r,i,e[c+5],5,-701558691),a,r,e[c+10],9,38016083),n,a,e[c+15],14,-660478335),i,n,e[c+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,n=md5_gg(n,a,r,i,e[c+9],5,568446438),a,r,e[c+14],9,-1019803690),n,a,e[c+3],14,-187363961),i,n,e[c+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,n=md5_gg(n,a,r,i,e[c+13],5,-1444681467),a,r,e[c+2],9,-51403784),n,a,e[c+7],14,1735328473),i,n,e[c+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,n=md5_hh(n,a,r,i,e[c+5],4,-378558),a,r,e[c+8],11,-2022574463),n,a,e[c+11],16,1839030562),i,n,e[c+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,n=md5_hh(n,a,r,i,e[c+1],4,-1530992060),a,r,e[c+4],11,1272893353),n,a,e[c+7],16,-155497632),i,n,e[c+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,n=md5_hh(n,a,r,i,e[c+13],4,681279174),a,r,e[c+0],11,-358537222),n,a,e[c+3],16,-722521979),i,n,e[c+6],23,76029189),r=md5_hh(r,i=md5_hh(i,n=md5_hh(n,a,r,i,e[c+9],4,-640364487),a,r,e[c+12],11,-421815835),n,a,e[c+15],16,530742520),i,n,e[c+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,n=md5_ii(n,a,r,i,e[c+0],6,-198630844),a,r,e[c+7],10,1126891415),n,a,e[c+14],15,-1416354905),i,n,e[c+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,n=md5_ii(n,a,r,i,e[c+12],6,1700485571),a,r,e[c+3],10,-1894986606),n,a,e[c+10],15,-1051523),i,n,e[c+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,n=md5_ii(n,a,r,i,e[c+8],6,1873313359),a,r,e[c+15],10,-30611744),n,a,e[c+6],15,-1560198380),i,n,e[c+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,n=md5_ii(n,a,r,i,e[c+4],6,-145523070),a,r,e[c+11],10,-1120210379),n,a,e[c+2],15,718787259),i,n,e[c+9],21,-343485551),n=safe_add(n,d),a=safe_add(a,h),r=safe_add(r,o),i=safe_add(i,f)}return Array(n,a,r,i)}(function X(e){for(var t=Array(e.length>>2),n=0;n<t.length;n++)t[n]=0;for(n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length)));return t.toLowerCase()};function md5_cmn(e,t,n,a,r,i){return safe_add(function bit_rol(e,t){return e<<t|e>>>32-t}(safe_add(safe_add(t,e),safe_add(a,i)),r),n)}function md5_ff(e,t,n,a,r,i,c){return md5_cmn(t&n|~t&a,e,t,r,i,c)}function md5_gg(e,t,n,a,r,i,c){return md5_cmn(t&a|n&~a,e,t,r,i,c)}function md5_hh(e,t,n,a,r,i,c){return md5_cmn(t^n^a,e,t,r,i,c)}function md5_ii(e,t,n,a,r,i,c){return md5_cmn(n^(t|~a),e,t,r,i,c)}function safe_add(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}async function FetchInChunks(e,t={}){const{chunkSize:n=5242880,maxParallelRequests:a=6,progressCallback:r=null,signal:i=null}=t;async function fetchChunk(e,t,n,a){const r=await fetch(e,{headers:{Range:`bytes=${t}-${n}`},signal:a});if(!r.ok&&206!==r.status)throw new Error("Failed to fetch chunk");return await r.arrayBuffer()}const c=await async function getFileSize(e,t){const n=await fetch(e,{method:"HEAD",signal:t});if(!n.ok)throw new Error("Failed to fetch the file size");const a=n.headers.get("content-length");if(!a)throw new Error("Content-Length header is missing");return parseInt(a,10)}(e,i),d=await async function downloadChunks(e,t,n,a,r,i){let c=[],d=[],h=0;return await async function processQueue(){let o=0;for(;o<t;){if(d.length<a){let a=Math.min(o+n-1,t-1),f=o,m=fetchChunk(e,o,a,i).then((e=>{c.push({start:f,chunk:e}),h+=e.byteLength,r&&r(h,t),d=d.filter((e=>e!==m))})).catch((e=>{throw e}));d.push(m),o+=n}d.length>=a&&await Promise.race(d)}await Promise.all(d)}(),c.sort(((e,t)=>e.start-t.start)).map((e=>e.chunk))}(e,c,n,a,r,i);return new Blob(d)}let e=134217728,t="JMWebAIModels",n=!1;async function fetchAndCacheFile(a,r){let i;try{return i=r?await FetchInChunks(a,{chunkSize:5242880,maxParallelRequests:10,progressCallback:(e,t)=>r("Loading file: "+Math.round(e/t*100)+"%")}):await FetchInChunks(a,{chunkSize:5242880,maxParallelRequests:10}),n&&console.log("Caching: "+a),async function cacheIt(a,r){try{const i=await caches.open(t);let c=0;for(let t=0;t<a.size;t+=e){let n;n=t+e>a.size?a.slice(t,a.size,"binary/octet-stream"):a.slice(t,t+e,"binary/octet-stream"),await i.put(MD5(r)+"-"+c,new Response(n)),c++}return await i.put(MD5(r),new Response(c)),n&&console.log("Cached: "+r),URL.createObjectURL(a)}catch(e){return console.error(e.name,e.message),URL.createObjectURL(a)}}(i,a)}catch(e){return console.warn("File does not exist! Returning null object."),null}}return{loadFromURL:async function fetchFile(e,a){n&&console.log("Attempting to fetch: "+e+" from cache.");try{const n=await caches.open(t),r=MD5(e),i=await n.match(r);let c=[];if(i){const t=await i.blob();let d=parseInt(await t.text());if(0===d)return await fetchAndCacheFile(e,a);{for(let e=0;e<d;e++){const t=await n.match(r+"-"+e);c.push(await t.blob())}let e=new Blob(c,{type:"binary/octet-stream"});return await URL.createObjectURL(e)}}return console.warn("Requested file not in cache - attempting to fetch and then cache."),await fetchAndCacheFile(e,a)}catch(e){console.error(e)}},setCacheName:function setCacheName(e){t=e},setShardSize:function setShardSize(t){e=t},enableDebug:function enableDebug(e){n=e}}}();export default FileProxyCache;
